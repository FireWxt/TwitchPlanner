<!-- BARRE DE NAVIGATION -->
<div class="topBar">
  <div class="logo">TwitchPlanner</div>
  <a routerLink="/profile" class="profileBox">
    <span class="profileIcon">ğŸ‘¤</span>
    <span class="profileText">Mon profil</span>
  </a>
</div>

<!-- HEADER -->
<div class="planningHeader" *ngIf="planning">
  <div class="left">
    <button class="backBtn" (click)="backToList()">â† Retour</button>
    <div class="title">{{ planning.title }}</div>
    <div class="range">
      {{ formatPlanningRange(planning.start_date, planning.end_date) }}
    </div>
  </div>

  <div class="right">
    <button class="downloadBtn" (click)="downloadPlanning()" title="TÃ©lÃ©charger">ğŸ’¾ TÃ©lÃ©charger</button>
    <div class="avatar">ğŸ‘¤</div>
  </div>
</div>

<!-- SI PAS DE PLANNING SELECTIONNE -->
<div *ngIf="!planning && !loading" class="empty">
  <h2>CrÃ©er un planning</h2>

  <label>Titre</label>
  <input [(ngModel)]="planningForm.title" />

  <label>DÃ©but</label>
  <input type="date" [(ngModel)]="planningForm.start_date" [min]="minStartDate" />

  <button (click)="createPlanning()">CrÃ©er</button>

  <div class="error" *ngIf="error">{{ error }}</div>

  <!-- LISTE DES PLANNINGS -->
  <div class="planningList" *ngIf="plannings.length > 0">
    <h3>Mes plannings</h3>
    <div class="planningItem" *ngFor="let p of plannings">
      <div class="planningItemInfo">
        <div class="planningItemTitle">{{ p.title }}</div>
        <div class="planningItemDates">{{ formatPlanningRange(p.start_date, p.end_date) }}</div>
      </div>
      <div class="planningItemActions">
        <button class="btnEdit" (click)="selectPlanning(p)">Modifier</button>
        <button class="btnDelete" (click)="deletePlanningById(p.Id_Planning, $event)">Supprimer</button>
      </div>
    </div>
  </div>

  <div *ngIf="plannings.length === 0" class="noPlannings">
    Aucun planning pour le moment.
  </div>
</div>

<!-- CHARGEMENT -->
<div *ngIf="loading" class="loading">Chargement...</div>

<!-- GRILLE -->
<div class="weekGrid" *ngIf="planning" #planningGrid>
  <div class="dayCol" *ngFor="let d of days">

    <div class="dayHeader">{{ d.label }}</div>

    <button class="addSlot" (click)="openAddEvent(d.value)">+</button>

    <!-- events -->
    <div class="eventCard" *ngFor="let ev of getEventsForDay(d.value)">
      
      <!-- IMAGE DU JEU -->
      <img *ngIf="ev.game_cover_url"
           [src]="ev.game_cover_url"
           class="eventCover" />
      <div class="noEventCover" *ngIf="!ev.game_cover_url">ğŸ®</div>

      <div class="eventOverlay">
        <div class="time">{{ ev.start_time }}</div>
        <div class="eventBottom">
          <div class="title" *ngIf="ev.stream_title">{{ ev.stream_title }}</div>
          <div class="gameName" *ngIf="ev.game_name">{{ ev.game_name }}</div>
        </div>
      </div>

      <div class="eventActions">
        <button class="editBtn" (click)="openEditEvent(ev)">âœ</button>
        <button class="trash" (click)="deleteEvenement(getEventId(ev))">âœ•</button>
      </div>
    </div>

    <div class="off" *ngIf="getEventsForDay(d.value).length === 0">
      OFF
    </div>

  </div>
</div>

<!-- MODAL AJOUT/EDIT EVENT -->
<div class="modalBackdrop" *ngIf="showEventForm">
  <div class="modal">
    <h3>{{ editingEventId ? 'Modifier le crÃ©neau' : 'Ajouter un crÃ©neau' }}</h3>

    <label>Titre</label>
    <input [(ngModel)]="eventForm.stream_title" />

    <label>Heure dÃ©but</label>
    <input type="time" [(ngModel)]="eventForm.start_time" />

    <label>Heure fin</label>
    <input type="time" [(ngModel)]="eventForm.end_time" />

    <!-- IGDB SEARCH -->
    <label>Jeu</label>
    <div class="gameSearchWrapper">

      <input
        [(ngModel)]="eventForm.game_query"
        (input)="onGameInput($any($event.target).value)"
        (blur)="hideGameDropdownSoon()"
        placeholder="Rechercher un jeu..."
        autocomplete="off"
      />

      <div class="loadingSmall" *ngIf="isSearchingGames">
        Recherche...
      </div>

      <div class="dropdown" *ngIf="showGameDropdown">
        <div class="gameGrid">
          <div class="gameCard"
               *ngFor="let g of gameResults"
               (mousedown)="selectGame(g)">
            
            <img *ngIf="g.cover"
                 [src]="g.cover"
                 class="gameCover" />
            <div class="noGameCover" *ngIf="!g.cover">?</div>

            <span class="gameName">{{ g.name }}</span>
          </div>
        </div>
      </div>

    </div>

    <!-- PREVIEW SELECTION -->
    <div class="selectedGame" *ngIf="eventForm.game_cover_url">
      <img [src]="eventForm.game_cover_url" class="selectedCover" />
      <div>{{ eventForm.game_name }}</div>
    </div>

    <div class="actions">
      <button (click)="addEvenement()">{{ editingEventId ? 'Modifier' : 'Ajouter' }}</button>
      <button (click)="closeAddEvent()">Annuler</button>
    </div>

    <div class="error" *ngIf="error">{{ error }}</div>
  </div>
</div>
